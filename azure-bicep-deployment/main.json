{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.34.44.8038",
      "templateHash": "7521402262418343388"
    }
  },
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "paymentapp",
      "metadata": {
        "description": "Nombre base del proyecto"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "test",
        "prod"
      ],
      "metadata": {
        "description": "Entorno de despliegue"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Ubicación para todos los recursos"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "CIDR de la red virtual"
      }
    },
    "appGatewaySubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.1.0/24",
      "metadata": {
        "description": "CIDR de la subnet para Application Gateway"
      }
    },
    "containerAppSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.0.2.0/24",
      "metadata": {
        "description": "CIDR de la subnet para Container Apps"
      }
    },
    "costCenter": {
      "type": "string",
      "defaultValue": "IT-Development",
      "metadata": {
        "description": "Centro de costos para facturación"
      }
    },
    "owner": {
      "type": "string",
      "defaultValue": "DevOps-Team",
      "metadata": {
        "description": "Responsable del recurso"
      }
    },
    "postgresAdminLogin": {
      "type": "string",
      "defaultValue": "pgadmin",
      "metadata": {
        "description": "Usuario administrador de PostgreSQL"
      }
    },
    "postgresAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Contraseña del administrador de PostgreSQL"
      }
    },
    "postgresVersion": {
      "type": "string",
      "defaultValue": "14",
      "allowedValues": [
        "13",
        "14",
        "15"
      ],
      "metadata": {
        "description": "Versión de PostgreSQL"
      }
    },
    "postgresSkuName": {
      "type": "string",
      "defaultValue": "Standard_B1ms",
      "metadata": {
        "description": "SKU del servidor PostgreSQL"
      }
    },
    "databaseName": {
      "type": "string",
      "defaultValue": "paymentdb",
      "metadata": {
        "description": "Nombre de la base de datos principal"
      }
    },
    "containerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "URL de la imagen del contenedor"
      }
    },
    "containerPort": {
      "type": "int",
      "defaultValue": 80,
      "metadata": {
        "description": "Puerto del contenedor"
      }
    },
    "minReplicas": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Número mínimo de réplicas"
      }
    },
    "maxReplicas": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "Número máximo de réplicas"
      }
    },
    "containerCpu": {
      "type": "string",
      "defaultValue": "0.25",
      "metadata": {
        "description": "CPU por contenedor"
      }
    },
    "containerMemory": {
      "type": "string",
      "defaultValue": "0.5Gi",
      "metadata": {
        "description": "Memoria por contenedor"
      }
    },
    "appInsightsRetentionDays": {
      "type": "int",
      "defaultValue": 90,
      "metadata": {
        "description": "Retention en días para Application Insights"
      }
    }
  },
  "variables": {
    "deploymentSuffix": "[uniqueString(resourceGroup().id)]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('infrastructure-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('vnetAddressPrefix')]"
          },
          "appGatewaySubnetPrefix": {
            "value": "[parameters('appGatewaySubnetPrefix')]"
          },
          "containerAppSubnetPrefix": {
            "value": "[parameters('containerAppSubnetPrefix')]"
          },
          "costCenter": {
            "value": "[parameters('costCenter')]"
          },
          "owner": {
            "value": "[parameters('owner')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "8431398880970024324"
            }
          },
          "parameters": {
            "projectName": {
              "type": "string",
              "defaultValue": "paymentapp",
              "metadata": {
                "description": "Nombre base del proyecto para nombrado de recursos"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Ubicación para todos los recursos"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Entorno de despliegue"
              }
            },
            "vnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "Prefijo de direcciones para la VNET"
              }
            },
            "appGatewaySubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/24",
              "metadata": {
                "description": "Prefijo de subred para Application Gateway"
              }
            },
            "containerAppSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.8.0/21",
              "metadata": {
                "description": "Prefijo de subred para Container Apps"
              }
            },
            "costCenter": {
              "type": "string",
              "defaultValue": "IT-Development",
              "metadata": {
                "description": "Centro de costos para facturación"
              }
            },
            "owner": {
              "type": "string",
              "defaultValue": "DevOps-Team",
              "metadata": {
                "description": "Responsable del recurso"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-{0}-{1}', parameters('projectName'), parameters('environment'))]",
            "appGatewaySubnetName": "subnet-appgw",
            "containerAppSubnetName": "subnet-containerapp",
            "nsgName": "[format('nsg-{0}-{1}', parameters('projectName'), parameters('environment'))]",
            "logAnalyticsWorkspaceName": "[format('law-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), uniqueString(resourceGroup().id))]",
            "commonTags": {
              "Environment": "[parameters('environment')]",
              "Project": "[parameters('projectName')]",
              "CostCenter": "[parameters('costCenter')]",
              "Owner": "[parameters('owner')]",
              "CreatedBy": "BICEP Template",
              "ManagedBy": "Infrastructure-as-Code",
              "Purpose": "Payment Application Infrastructure"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[variables('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowHTTPS",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowHTTP",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAppGwManagement",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "65200-65535",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 1000,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('appGatewaySubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('appGatewaySubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      }
                    }
                  },
                  {
                    "name": "[variables('containerAppSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('containerAppSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
                      },
                      "delegations": [
                        {
                          "name": "Microsoft.App.environments",
                          "properties": {
                            "serviceName": "Microsoft.App/environments"
                          }
                        }
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              ]
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": -1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "El ID de la VNET creada"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "El nombre de la VNET"
              },
              "value": "[variables('vnetName')]"
            },
            "appGatewaySubnetId": {
              "type": "string",
              "metadata": {
                "description": "El ID de la subred del Application Gateway"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-04-01').subnets[0].id]"
            },
            "appGatewaySubnetName": {
              "type": "string",
              "metadata": {
                "description": "El nombre de la subred del Application Gateway"
              },
              "value": "[variables('appGatewaySubnetName')]"
            },
            "containerAppSubnetId": {
              "type": "string",
              "metadata": {
                "description": "El ID de la subred de Container Apps"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-04-01').subnets[1].id]"
            },
            "containerAppSubnetName": {
              "type": "string",
              "metadata": {
                "description": "El nombre de la subred de Container Apps"
              },
              "value": "[variables('containerAppSubnetName')]"
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "El ID del Network Security Group"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
            },
            "nsgName": {
              "type": "string",
              "metadata": {
                "description": "El nombre del Network Security Group"
              },
              "value": "[variables('nsgName')]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "El ID de Log Analytics Workspace"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "El nombre de Log Analytics Workspace"
              },
              "value": "[variables('logAnalyticsWorkspaceName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('postgresql-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "administratorLogin": {
            "value": "[parameters('postgresAdminLogin')]"
          },
          "administratorLoginPassword": {
            "value": "[parameters('postgresAdminPassword')]"
          },
          "postgresVersion": {
            "value": "[parameters('postgresVersion')]"
          },
          "skuName": {
            "value": "[parameters('postgresSkuName')]"
          },
          "databaseName": {
            "value": "[parameters('databaseName')]"
          },
          "costCenter": {
            "value": "[parameters('costCenter')]"
          },
          "owner": {
            "value": "[parameters('owner')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "1969494455730857502"
            }
          },
          "parameters": {
            "projectName": {
              "type": "string",
              "defaultValue": "paymentapp",
              "metadata": {
                "description": "Nombre base del proyecto"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Entorno de despliegue"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Ubicación para todos los recursos"
              }
            },
            "administratorLogin": {
              "type": "string",
              "defaultValue": "pgadmin",
              "metadata": {
                "description": "Usuario administrador de PostgreSQL"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Contraseña del administrador de PostgreSQL"
              }
            },
            "postgresVersion": {
              "type": "string",
              "defaultValue": "14",
              "allowedValues": [
                "13",
                "14",
                "15"
              ],
              "metadata": {
                "description": "Versión de PostgreSQL"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_B1ms",
              "metadata": {
                "description": "SKU del servidor PostgreSQL"
              }
            },
            "tier": {
              "type": "string",
              "defaultValue": "Burstable",
              "allowedValues": [
                "Burstable",
                "GeneralPurpose",
                "MemoryOptimized"
              ],
              "metadata": {
                "description": "Tier de PostgreSQL"
              }
            },
            "storageSizeGB": {
              "type": "int",
              "defaultValue": 32,
              "metadata": {
                "description": "Tamaño de almacenamiento en GB"
              }
            },
            "databaseName": {
              "type": "string",
              "defaultValue": "paymentdb",
              "metadata": {
                "description": "Nombre de la base de datos principal"
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Backup retention en días"
              }
            },
            "geoRedundantBackup": {
              "type": "string",
              "defaultValue": "Disabled",
              "metadata": {
                "description": "Habilitar backup geo-redundante"
              }
            },
            "costCenter": {
              "type": "string",
              "defaultValue": "IT-Development",
              "metadata": {
                "description": "Centro de costos para facturación"
              }
            },
            "owner": {
              "type": "string",
              "defaultValue": "DevOps-Team",
              "metadata": {
                "description": "Responsable del recurso"
              }
            }
          },
          "variables": {
            "serverName": "[format('pg-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), uniqueString(resourceGroup().id))]",
            "commonTags": {
              "Environment": "[parameters('environment')]",
              "Project": "[parameters('projectName')]",
              "CostCenter": "[parameters('costCenter')]",
              "Owner": "[parameters('owner')]",
              "CreatedBy": "BICEP Template",
              "ManagedBy": "Infrastructure-as-Code",
              "Purpose": "Payment Application Database"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2023-03-01-preview",
              "name": "[variables('serverName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('tier')]"
              },
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "version": "[parameters('postgresVersion')]",
                "storage": {
                  "storageSizeGB": "[parameters('storageSizeGB')]",
                  "autoGrow": "Enabled"
                },
                "backup": {
                  "backupRetentionDays": "[parameters('backupRetentionDays')]",
                  "geoRedundantBackup": "[parameters('geoRedundantBackup')]"
                },
                "highAvailability": {
                  "mode": "Disabled"
                },
                "maintenanceWindow": {
                  "customWindow": "Disabled"
                },
                "authConfig": {
                  "activeDirectoryAuth": "Disabled",
                  "passwordAuth": "Enabled"
                }
              }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
              "apiVersion": "2023-03-01-preview",
              "name": "[format('{0}/{1}', variables('serverName'), parameters('databaseName'))]",
              "properties": {
                "charset": "UTF8",
                "collation": "en_US.UTF8"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
              "apiVersion": "2023-03-01-preview",
              "name": "[format('{0}/{1}', variables('serverName'), 'AllowAzureServices')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers/configurations",
              "apiVersion": "2023-03-01-preview",
              "name": "[format('{0}/{1}', variables('serverName'), 'log_statement')]",
              "properties": {
                "value": "all",
                "source": "user-override"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName'))]"
              ]
            }
          ],
          "outputs": {
            "serverName": {
              "type": "string",
              "metadata": {
                "description": "El nombre del servidor PostgreSQL"
              },
              "value": "[variables('serverName')]"
            },
            "serverFQDN": {
              "type": "string",
              "metadata": {
                "description": "El FQDN del servidor PostgreSQL"
              },
              "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName')), '2023-03-01-preview').fullyQualifiedDomainName]"
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "El nombre de la base de datos"
              },
              "value": "[parameters('databaseName')]"
            },
            "connectionStringTemplate": {
              "type": "string",
              "metadata": {
                "description": "String de conexión para aplicaciones (sin contraseña)"
              },
              "value": "[format('Server={0};Database={1};Port=5432;User Id={2};Ssl Mode=Require;', reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName')), '2023-03-01-preview').fullyQualifiedDomainName, parameters('databaseName'), parameters('administratorLogin'))]"
            },
            "serverId": {
              "type": "string",
              "metadata": {
                "description": "El ID del servidor PostgreSQL"
              },
              "value": "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('serverName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('container-env-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.logAnalyticsWorkspaceName.value]"
          },
          "costCenter": {
            "value": "[parameters('costCenter')]"
          },
          "owner": {
            "value": "[parameters('owner')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "13513671760819601783"
            }
          },
          "parameters": {
            "projectName": {
              "type": "string",
              "defaultValue": "paymentapp",
              "metadata": {
                "description": "Nombre base del proyecto"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Entorno de despliegue"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Ubicación para todos los recursos"
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "Nombre del workspace de Log Analytics"
              }
            },
            "costCenter": {
              "type": "string",
              "defaultValue": "IT-Development",
              "metadata": {
                "description": "Centro de costos para facturación"
              }
            },
            "owner": {
              "type": "string",
              "defaultValue": "DevOps-Team",
              "metadata": {
                "description": "Responsable del recurso"
              }
            }
          },
          "variables": {
            "containerAppEnvironmentName": "[format('cae-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), uniqueString(resourceGroup().id))]",
            "commonTags": {
              "Environment": "[parameters('environment')]",
              "Project": "[parameters('projectName')]",
              "CostCenter": "[parameters('costCenter')]",
              "Owner": "[parameters('owner')]",
              "CreatedBy": "BICEP Template",
              "ManagedBy": "Infrastructure-as-Code",
              "Purpose": "Payment Application Container Environment"
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2023-05-01",
              "name": "[variables('containerAppEnvironmentName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
                  }
                },
                "zoneRedundant": false,
                "kedaConfiguration": {},
                "daprConfiguration": {},
                "customDomainConfiguration": {
                  "dnsSuffix": "",
                  "certificatePassword": "",
                  "certificateValue": ""
                }
              }
            }
          ],
          "outputs": {
            "containerAppEnvironmentName": {
              "type": "string",
              "metadata": {
                "description": "El nombre del Container Apps Environment"
              },
              "value": "[variables('containerAppEnvironmentName')]"
            },
            "containerAppEnvironmentId": {
              "type": "string",
              "metadata": {
                "description": "El ID del Container Apps Environment"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvironmentName'))]"
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "El dominio por defecto del Container Apps Environment"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvironmentName')), '2023-05-01').defaultDomain]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('monitoring-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.logAnalyticsWorkspaceName.value]"
          },
          "retentionInDays": {
            "value": "[parameters('appInsightsRetentionDays')]"
          },
          "costCenter": {
            "value": "[parameters('costCenter')]"
          },
          "owner": {
            "value": "[parameters('owner')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "18011001018422332629"
            }
          },
          "parameters": {
            "projectName": {
              "type": "string",
              "defaultValue": "paymentapp",
              "metadata": {
                "description": "Nombre base del proyecto"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Entorno de despliegue"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Ubicación para todos los recursos"
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "Nombre del workspace de Log Analytics"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "metadata": {
                "description": "Retention en días para Application Insights"
              }
            },
            "costCenter": {
              "type": "string",
              "defaultValue": "IT-Development",
              "metadata": {
                "description": "Centro de costos para facturación"
              }
            },
            "owner": {
              "type": "string",
              "defaultValue": "DevOps-Team",
              "metadata": {
                "description": "Responsable del recurso"
              }
            }
          },
          "variables": {
            "applicationInsightsName": "[format('ai-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), uniqueString(resourceGroup().id))]",
            "commonTags": {
              "Environment": "[parameters('environment')]",
              "Project": "[parameters('projectName')]",
              "CostCenter": "[parameters('costCenter')]",
              "Owner": "[parameters('owner')]",
              "CreatedBy": "BICEP Template",
              "ManagedBy": "Infrastructure-as-Code",
              "Purpose": "Payment Application Monitoring"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "Flow_Type": "Redfield",
                "Request_Source": "rest",
                "RetentionInDays": "[parameters('retentionInDays')]",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/actionGroups",
              "apiVersion": "2023-01-01",
              "name": "[format('ag-{0}-{1}', parameters('projectName'), parameters('environment'))]",
              "location": "Global",
              "tags": "[variables('commonTags')]",
              "properties": {
                "groupShortName": "[format('{0}{1}', parameters('projectName'), parameters('environment'))]",
                "enabled": true,
                "emailReceivers": [],
                "smsReceivers": [],
                "webhookReceivers": [],
                "azureAppPushReceivers": [],
                "itsmReceivers": [],
                "azureFunctionReceivers": [],
                "eventHubReceivers": [],
                "armRoleReceivers": [],
                "logicAppReceivers": [],
                "automationRunbookReceivers": [],
                "voiceReceivers": []
              }
            },
            {
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[format('alert-{0}-{1}-response-time', parameters('projectName'), parameters('environment'))]",
              "location": "Global",
              "tags": "[variables('commonTags')]",
              "properties": {
                "description": "Alert when response time is greater than 5 seconds",
                "severity": 2,
                "enabled": true,
                "scopes": [
                  "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                ],
                "evaluationFrequency": "PT1M",
                "windowSize": "PT5M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "criterionType": "StaticThresholdCriterion",
                      "name": "ResponseTime",
                      "metricName": "requests/duration",
                      "operator": "GreaterThan",
                      "threshold": 5000,
                      "timeAggregation": "Average"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', parameters('projectName'), parameters('environment')))]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', parameters('projectName'), parameters('environment')))]",
                "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[format('alert-{0}-{1}-error-rate', parameters('projectName'), parameters('environment'))]",
              "location": "Global",
              "tags": "[variables('commonTags')]",
              "properties": {
                "description": "Alert when error rate is greater than 5%",
                "severity": 1,
                "enabled": true,
                "scopes": [
                  "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                ],
                "evaluationFrequency": "PT1M",
                "windowSize": "PT5M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "criterionType": "StaticThresholdCriterion",
                      "name": "ErrorRate",
                      "metricName": "requests/failed",
                      "operator": "GreaterThan",
                      "threshold": 5,
                      "timeAggregation": "Percent"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', parameters('projectName'), parameters('environment')))]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', parameters('projectName'), parameters('environment')))]",
                "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
              ]
            }
          ],
          "outputs": {
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "El nombre de Application Insights"
              },
              "value": "[variables('applicationInsightsName')]"
            },
            "applicationInsightsId": {
              "type": "string",
              "metadata": {
                "description": "El ID de Application Insights"
              },
              "value": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "La clave de instrumentación de Application Insights"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "La cadena de conexión de Application Insights"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').ConnectionString]"
            },
            "actionGroupName": {
              "type": "string",
              "metadata": {
                "description": "El nombre del Action Group"
              },
              "value": "[format('ag-{0}-{1}', parameters('projectName'), parameters('environment'))]"
            },
            "actionGroupId": {
              "type": "string",
              "metadata": {
                "description": "El ID del Action Group"
              },
              "value": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', parameters('projectName'), parameters('environment')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('container-apps-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "containerAppEnvironmentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('container-env-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppEnvironmentName.value]"
          },
          "containerImage": {
            "value": "[parameters('containerImage')]"
          },
          "containerPort": {
            "value": "[parameters('containerPort')]"
          },
          "postgresConnectionString": {
            "value": "[format('Server={0};Database={1};Port=5432;User Id={2};Password={3};Ssl Mode=Require;', reference(resourceId('Microsoft.Resources/deployments', format('postgresql-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.serverFQDN.value, reference(resourceId('Microsoft.Resources/deployments', format('postgresql-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.databaseName.value, parameters('postgresAdminLogin'), parameters('postgresAdminPassword'))]"
          },
          "applicationInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('monitoring-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.connectionString.value]"
          },
          "minReplicas": {
            "value": "[parameters('minReplicas')]"
          },
          "maxReplicas": {
            "value": "[parameters('maxReplicas')]"
          },
          "cpu": {
            "value": "[parameters('containerCpu')]"
          },
          "memory": {
            "value": "[parameters('containerMemory')]"
          },
          "costCenter": {
            "value": "[parameters('costCenter')]"
          },
          "owner": {
            "value": "[parameters('owner')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "10664986251278253511"
            }
          },
          "parameters": {
            "projectName": {
              "type": "string",
              "defaultValue": "paymentapp",
              "metadata": {
                "description": "Nombre base del proyecto"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Entorno de despliegue"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Ubicación para todos los recursos"
              }
            },
            "containerAppEnvironmentName": {
              "type": "string",
              "metadata": {
                "description": "Nombre del Container Apps Environment"
              }
            },
            "containerImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "metadata": {
                "description": "URL de la imagen del contenedor"
              }
            },
            "containerPort": {
              "type": "int",
              "defaultValue": 80,
              "metadata": {
                "description": "Puerto del contenedor"
              }
            },
            "postgresConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "String de conexión de PostgreSQL"
              }
            },
            "applicationInsightsConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Cadena de conexión de Application Insights"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Número mínimo de réplicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "Número máximo de réplicas"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.25",
              "metadata": {
                "description": "CPU por contenedor"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "0.5Gi",
              "metadata": {
                "description": "Memoria por contenedor"
              }
            },
            "costCenter": {
              "type": "string",
              "defaultValue": "IT-Development",
              "metadata": {
                "description": "Centro de costos para facturación"
              }
            },
            "owner": {
              "type": "string",
              "defaultValue": "DevOps-Team",
              "metadata": {
                "description": "Responsable del recurso"
              }
            }
          },
          "variables": {
            "containerAppName": "[format('ca-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), uniqueString(resourceGroup().id))]",
            "commonTags": {
              "Environment": "[parameters('environment')]",
              "Project": "[parameters('projectName')]",
              "CostCenter": "[parameters('costCenter')]",
              "Owner": "[parameters('owner')]",
              "CreatedBy": "BICEP Template",
              "ManagedBy": "Infrastructure-as-Code",
              "Purpose": "Payment Application Runtime"
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2023-05-01",
              "name": "[variables('containerAppName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppEnvironmentName'))]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": true,
                    "targetPort": "[parameters('containerPort')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "weight": 100,
                        "latestRevision": true
                      }
                    ]
                  },
                  "secrets": [
                    {
                      "name": "postgres-connection-string",
                      "value": "[parameters('postgresConnectionString')]"
                    },
                    {
                      "name": "appinsights-connection-string",
                      "value": "[parameters('applicationInsightsConnectionString')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "payment-api",
                      "image": "[parameters('containerImage')]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": [
                        {
                          "name": "DATABASE_CONNECTION_STRING",
                          "secretRef": "postgres-connection-string"
                        },
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "secretRef": "appinsights-connection-string"
                        },
                        {
                          "name": "ASPNETCORE_ENVIRONMENT",
                          "value": "[parameters('environment')]"
                        },
                        {
                          "name": "ASPNETCORE_URLS",
                          "value": "[format('http://+:{0}', parameters('containerPort'))]"
                        }
                      ],
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('containerPort')]",
                            "scheme": "HTTP"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "timeoutSeconds": 10,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health/ready",
                            "port": "[parameters('containerPort')]",
                            "scheme": "HTTP"
                          },
                          "initialDelaySeconds": 5,
                          "periodSeconds": 10,
                          "timeoutSeconds": 5,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scale-rule",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "10"
                          }
                        }
                      },
                      {
                        "name": "cpu-scale-rule",
                        "custom": {
                          "type": "cpu",
                          "metadata": {
                            "type": "Utilization",
                            "value": "70"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppName": {
              "type": "string",
              "metadata": {
                "description": "El nombre del Container App"
              },
              "value": "[variables('containerAppName')]"
            },
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "El ID del Container App"
              },
              "value": "[resourceId('Microsoft.App/containerApps', variables('containerAppName'))]"
            },
            "containerAppFQDN": {
              "type": "string",
              "metadata": {
                "description": "El FQDN del Container App"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01').configuration.ingress.fqdn]"
            },
            "containerAppUrl": {
              "type": "string",
              "metadata": {
                "description": "La URL completa del Container App"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('containerAppName')), '2023-05-01').configuration.ingress.fqdn)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('container-env-{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('monitoring-{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('postgresql-{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('app-gateway-{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "virtualNetworkName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnetName.value]"
          },
          "subnetName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.appGatewaySubnetName.value]"
          },
          "containerAppFQDN": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('container-apps-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppFQDN.value]"
          },
          "costCenter": {
            "value": "[parameters('costCenter')]"
          },
          "owner": {
            "value": "[parameters('owner')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "18329239494284973064"
            }
          },
          "parameters": {
            "projectName": {
              "type": "string",
              "defaultValue": "paymentapp",
              "metadata": {
                "description": "Nombre base del proyecto"
              }
            },
            "environment": {
              "type": "string",
              "defaultValue": "dev",
              "allowedValues": [
                "dev",
                "test",
                "prod"
              ],
              "metadata": {
                "description": "Entorno de despliegue"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Ubicación para todos los recursos"
              }
            },
            "virtualNetworkName": {
              "type": "string",
              "metadata": {
                "description": "Nombre de la red virtual"
              }
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "Nombre de la subnet para Application Gateway"
              }
            },
            "containerAppFQDN": {
              "type": "string",
              "metadata": {
                "description": "FQDN del Container App (backend)"
              }
            },
            "costCenter": {
              "type": "string",
              "defaultValue": "IT-Development",
              "metadata": {
                "description": "Centro de costos para facturación"
              }
            },
            "owner": {
              "type": "string",
              "defaultValue": "DevOps-Team",
              "metadata": {
                "description": "Responsable del recurso"
              }
            }
          },
          "variables": {
            "applicationGatewayName": "[format('agw-{0}-{1}-{2}', parameters('projectName'), parameters('environment'), uniqueString(resourceGroup().id))]",
            "publicIpName": "[format('pip-{0}', variables('applicationGatewayName'))]",
            "commonTags": {
              "Environment": "[parameters('environment')]",
              "Project": "[parameters('projectName')]",
              "CostCenter": "[parameters('costCenter')]",
              "Owner": "[parameters('owner')]",
              "CreatedBy": "BICEP Template",
              "ManagedBy": "Infrastructure-as-Code",
              "Purpose": "Payment Application Gateway"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-05-01",
              "name": "[variables('publicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4",
                "dnsSettings": {
                  "domainNameLabel": "[format('{0}-{1}-{2}', parameters('projectName'), parameters('environment'), uniqueString(resourceGroup().id))]"
                }
              }
            },
            {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2023-05-01",
              "name": "[variables('applicationGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('commonTags')]",
              "properties": {
                "sku": {
                  "name": "Standard_v2",
                  "tier": "Standard_v2",
                  "capacity": 1
                },
                "gatewayIPConfigurations": [
                  {
                    "name": "appGwIpConfig",
                    "properties": {
                      "subnet": {
                        "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]"
                      }
                    }
                  }
                ],
                "frontendIPConfigurations": [
                  {
                    "name": "appGwPublicFrontendIp",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
                      }
                    }
                  }
                ],
                "frontendPorts": [
                  {
                    "name": "port_80",
                    "properties": {
                      "port": 80
                    }
                  }
                ],
                "backendAddressPools": [
                  {
                    "name": "containerAppBackendPool",
                    "properties": {
                      "backendAddresses": [
                        {
                          "fqdn": "[parameters('containerAppFQDN')]"
                        }
                      ]
                    }
                  }
                ],
                "backendHttpSettingsCollection": [
                  {
                    "name": "appGwBackendHttpSettings",
                    "properties": {
                      "port": 443,
                      "protocol": "Https",
                      "cookieBasedAffinity": "Disabled",
                      "pickHostNameFromBackendAddress": true,
                      "requestTimeout": 20,
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/probes', variables('applicationGatewayName'), 'containerAppProbe')]"
                      }
                    }
                  }
                ],
                "httpListeners": [
                  {
                    "name": "appGwHttpListener",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('applicationGatewayName'), 'appGwPublicFrontendIp')]"
                      },
                      "frontendPort": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('applicationGatewayName'), 'port_80')]"
                      },
                      "protocol": "Http"
                    }
                  }
                ],
                "requestRoutingRules": [
                  {
                    "name": "rule1",
                    "properties": {
                      "ruleType": "Basic",
                      "httpListener": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('applicationGatewayName'), 'appGwHttpListener')]"
                      },
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('applicationGatewayName'), 'containerAppBackendPool')]"
                      },
                      "backendHttpSettings": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('applicationGatewayName'), 'appGwBackendHttpSettings')]"
                      }
                    }
                  }
                ],
                "probes": [
                  {
                    "name": "containerAppProbe",
                    "properties": {
                      "protocol": "Https",
                      "path": "/health",
                      "interval": 30,
                      "timeout": 30,
                      "unhealthyThreshold": 3,
                      "pickHostNameFromBackendHttpSettings": true,
                      "minServers": 0,
                      "match": {
                        "statusCodes": [
                          "200-399"
                        ]
                      }
                    }
                  }
                ],
                "enableHttp2": true,
                "autoscaleConfiguration": {
                  "minCapacity": 1,
                  "maxCapacity": 3
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              ]
            }
          ],
          "outputs": {
            "applicationGatewayName": {
              "type": "string",
              "metadata": {
                "description": "El nombre del Application Gateway"
              },
              "value": "[variables('applicationGatewayName')]"
            },
            "applicationGatewayId": {
              "type": "string",
              "metadata": {
                "description": "El ID del Application Gateway"
              },
              "value": "[resourceId('Microsoft.Network/applicationGateways', variables('applicationGatewayName'))]"
            },
            "publicIPAddress": {
              "type": "string",
              "metadata": {
                "description": "La IP pública del Application Gateway"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2023-05-01').ipAddress]"
            },
            "publicFQDN": {
              "type": "string",
              "metadata": {
                "description": "El FQDN público del Application Gateway"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2023-05-01').dnsSettings.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('container-apps-{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix')))]"
      ]
    }
  ],
  "outputs": {
    "infrastructure": {
      "type": "object",
      "metadata": {
        "description": "Información de la infraestructura"
      },
      "value": {
        "virtualNetworkName": "[reference(resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnetName.value]",
        "logAnalyticsWorkspaceName": "[reference(resourceId('Microsoft.Resources/deployments', format('infrastructure-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.logAnalyticsWorkspaceName.value]"
      }
    },
    "database": {
      "type": "object",
      "metadata": {
        "description": "Información de PostgreSQL"
      },
      "value": {
        "serverName": "[reference(resourceId('Microsoft.Resources/deployments', format('postgresql-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.serverName.value]",
        "serverFQDN": "[reference(resourceId('Microsoft.Resources/deployments', format('postgresql-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.serverFQDN.value]",
        "databaseName": "[reference(resourceId('Microsoft.Resources/deployments', format('postgresql-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.databaseName.value]"
      }
    },
    "containerEnvironment": {
      "type": "object",
      "metadata": {
        "description": "Información del Container App Environment"
      },
      "value": {
        "name": "[reference(resourceId('Microsoft.Resources/deployments', format('container-env-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppEnvironmentName.value]",
        "id": "[reference(resourceId('Microsoft.Resources/deployments', format('container-env-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppEnvironmentId.value]",
        "defaultDomain": "[reference(resourceId('Microsoft.Resources/deployments', format('container-env-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.defaultDomain.value]"
      }
    },
    "monitoring": {
      "type": "object",
      "metadata": {
        "description": "Información de Monitoring"
      },
      "value": {
        "applicationInsightsName": "[reference(resourceId('Microsoft.Resources/deployments', format('monitoring-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.applicationInsightsName.value]",
        "instrumentationKey": "[reference(resourceId('Microsoft.Resources/deployments', format('monitoring-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.instrumentationKey.value]",
        "connectionString": "[reference(resourceId('Microsoft.Resources/deployments', format('monitoring-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.connectionString.value]"
      }
    },
    "containerApp": {
      "type": "object",
      "metadata": {
        "description": "Información del Container App"
      },
      "value": {
        "name": "[reference(resourceId('Microsoft.Resources/deployments', format('container-apps-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppName.value]",
        "fqdn": "[reference(resourceId('Microsoft.Resources/deployments', format('container-apps-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppFQDN.value]",
        "url": "[reference(resourceId('Microsoft.Resources/deployments', format('container-apps-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppUrl.value]"
      }
    },
    "applicationGateway": {
      "type": "object",
      "metadata": {
        "description": "Información del Application Gateway"
      },
      "value": {
        "name": "[reference(resourceId('Microsoft.Resources/deployments', format('app-gateway-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.applicationGatewayName.value]",
        "publicIPAddress": "[reference(resourceId('Microsoft.Resources/deployments', format('app-gateway-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.publicIPAddress.value]",
        "publicFQDN": "[reference(resourceId('Microsoft.Resources/deployments', format('app-gateway-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.publicFQDN.value]"
      }
    },
    "accessUrls": {
      "type": "object",
      "metadata": {
        "description": "URLs de acceso de la aplicación"
      },
      "value": {
        "applicationGateway": "[format('http://{0}', reference(resourceId('Microsoft.Resources/deployments', format('app-gateway-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.publicFQDN.value)]",
        "containerAppDirect": "[reference(resourceId('Microsoft.Resources/deployments', format('container-apps-{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppUrl.value]"
      }
    }
  }
}